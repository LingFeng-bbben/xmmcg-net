# Django Admin 快速操作指南

## 📊 后台管理员功能概览

本指南说明如何在 Django Admin 中快速操作新的谱面竞标功能。

---

## 🚀 快速创建谱面竞标轮次

### 方式 1：通过 Admin Action（推荐）

1. 进入 Django Admin → **竞标轮次** (`/admin/songs/biddinground/`)
2. 在列表页面，选择 **Bulk actions** 下拉菜单
3. 选择 **"快速创建谱面竞标轮次（自动筛选半成品谱面）"**
4. 点击 **Go**

**系统会自动：**
- ✅ 统计所有 `status='part_submitted'`（半成品）的谱面
- ✅ 创建新的 `BiddingRound`，`bidding_type='chart'`，`status='active'`
- ✅ 生成轮次名称：`第二轮竞标 - 谱面完成 (YYYY-MM-DD HH:MM)`
- ✅ 显示成功消息和谱面数量

### 方式 2：手动创建

1. 进入 Django Admin → **竞标轮次** (`/admin/songs/biddinground/`)
2. 点击 **Add Bidding Round**
3. 填写字段：
   - **Name**：`第二轮竞标 - 谱面完成`
   - **Bidding type**：选择 `谱面竞标`（chart）
   - **Status**：选择 `进行中`（active）
   - **Competition phase**：可选，选择对应的阶段

4. 点击 **Save**

---

## 📋 查看可竞标的谱面

### 方式 1：在 BiddingRound 列表中查看

1. 进入 **竞标轮次** 列表页面
2. 查看 **可用目标数** 列（新增字段）
3. 显示该轮次对应类型的可用目标数

**说明：**
- 歌曲竞标轮次：显示所有歌曲数
- 谱面竞标轮次：显示所有半成品谱面数

### 方式 2：在 Chart 列表中查看

1. 进入 Django Admin → **谱面** (`/admin/songs/chart/`)
2. 在 **Status** 筛选器中选择 **"半成品"** (`part_submitted`)
3. 查看所有可竞标的谱面列表

**新增功能：**
- ✨ 列表中现在显示 **设计者** (designer) 字段
- ✨ 支持按设计者名义搜索
- ✨ **Bulk actions** 中有 "查看可竞标的谱面" 操作，显示当前可竞标数

---

## 🎯 分配竞标

### 步骤 1：确保用户已竞标

1. 进入 **竞标** (`/admin/songs/bid/`) 查看所有竞标记录
2. 使用筛选器查看特定轮次的竞标
3. 确认竞标轮次状态为 **"进行中"** (`active`)

### 步骤 2：触发分配

1. 进入 **竞标轮次** (`/admin/songs/biddinground/`)
2. 找到要分配的轮次
3. 勾选该轮次前的复选框
4. 在 **Bulk actions** 下拉菜单中选择 **"分配选中的竞标轮次"**
5. 点击 **Go**

**系统会自动：**
- ✅ 按出价从高到低排序
- ✅ 分配谱面给用户
- ✅ 标记失败的竞标为 drop
- ✅ 随机分配未获得目标的用户
- ✅ 将轮次状态改为 **"已完成"** (`completed`)

**注意：** 
- 已完成的轮次无法再次分配，会显示警告信息
- 所有未分配的用户会显示在结果消息中

---

## 📊 查看竞标结果

### 查看所有分配结果

1. 进入 **竞标分配结果** (`/admin/songs/bidresult/`)
2. 使用筛选器查看特定轮次的结果
3. 查看列表显示：

| 列 | 说明 |
|---|---|
| Bidding Round | 所属轮次 |
| Bid Type | 竞标类型（歌曲/谱面） |
| Song / Chart | 分配的目标 |
| User | 中标用户 |
| Bid Amount | 出价金额 |
| Allocation Type | 分配类型（竞标获胜/随机分配） |
| Allocated At | 分配时间 |

### 查看特定用户的结果

1. 进入 **竞标分配结果** 
2. 在搜索框输入用户名
3. 查看该用户所有中标的目标

---

## 🔍 谱面管理

### 查看所有谱面

1. 进入 **谱面** (`/admin/songs/chart/`)
2. 列表显示：

| 列 | 说明 |
|---|---|
| ID | 谱面 ID |
| User | 创建者 |
| Song | 对应歌曲 |
| Status | 谱面状态 |
| Is Part One | 是否为第一部分 |
| Designer | 设计者名义 |
| Review Count | 评分数 |
| Average Score | 平均分 |
| Created At | 创建时间 |

### 按状态筛选

在 **Status** 筛选器中选择：
- **半成品** (`part_submitted`) - 可竞标的谱面
- **完稿** (`final_submitted`) - 已完成但未评分
- **评分中** (`under_review`) - 正在进行互评
- **已评分** (`reviewed`) - 已完成评分

### 编辑谱面信息

1. 点击某个谱面进入编辑页面
2. 可编辑字段：
   - **Designer**（设计者名义）- 从 maidata.txt 读取
   - **Status**（状态）- 手动调整进度
   - **Comment**（备注）

---

## 💡 高级用法

### 批量创建多个谱面竞标轮次

**场景**：需要创建多个独立的谱面竞标轮次

**方法**：
1. 进入竞标轮次列表
2. 重复使用 "快速创建谱面竞标轮次" action
3. 系统会自动生成不同名称的轮次

**注意**：
- 每次创建都会筛选 **当前所有** 的半成品谱面
- 如果第一轮竞标中有用户完成了谱面，状态会变为 `final_submitted`，则不会出现在第二轮中

### 监控竞标进度

1. 进入 **竞标** 列表
2. 使用筛选器按轮次查看
3. 观察：
   - 当前竞标总数
   - 每个用户的竞标数
   - 是否有用户重复竞标同一目标

### 检查分配是否正常

1. 创建轮次后，进入该轮次的竞标列表
2. 分配后，进入竞标结果列表
3. 验证：
   - ✓ 每个用户最多中标一个目标
   - ✓ 高出价的用户优先获得
   - ✓ 所有用户都有中标结果

---

## 🎮 界面操作演示

### 场景：完成一个完整的谱面竞标流程

```
Step 1: 查看当前半成品谱面
  → 进入 Chart 列表
  → 筛选 Status = "半成品"
  → 看到 8 个可竞标的谱面 ✓

Step 2: 创建谱面竞标轮次
  → 进入 BiddingRound 列表
  → 点击 Action: "快速创建谱面竞标轮次"
  → 看到成功消息：包含 8 个半成品谱面 ✓

Step 3: 用户竞标（通过前端 API）
  → 用户在前端竞标 3-8 个不同的谱面
  → 检查 Bid 列表确认所有竞标已记录 ✓

Step 4: 分配竞标
  → 进入 BiddingRound 列表
  → 选中新创建的轮次
  → 点击 Action: "分配选中的竞标轮次"
  → 看到成功消息：成功分配 1 个竞标轮次 ✓

Step 5: 验证结果
  → 进入 BidResult 列表
  → 筛选新轮次
  → 看到 8 个分配结果（每个用户 1 个）✓
  → 点击某个结果，查看用户获得的谱面

Step 6: 用户开始完成谱面
  → 用户登录前端
  → 查看自己的中标结果
  → 开始完成谱面的后半部分
```

---

## 📞 故障排查

### 问题 1：创建谱面竞标轮次时出现"没有半成品谱面"错误

**原因**：当前系统中没有状态为 `part_submitted` 的谱面

**解决**：
1. 进入 Chart 列表
2. 检查是否有其他状态的谱面
3. 如果有 `created` 或 `submitted` 状态，说明数据在旧系统中
4. 使用 Django Shell 批量更新：
   ```python
   from songs.models import Chart
   Chart.objects.filter(status__in=['created', 'submitted']).update(status='part_submitted')
   ```

### 问题 2：分配失败，显示"只能对'进行中'的竞标轮次进行分配"

**原因**：轮次状态不是 `active`，可能已经分配过

**解决**：
1. 检查轮次状态是否为 "进行中" (active)
2. 如果已经是 "已完成"，无法再分配
3. 需要创建新的轮次

### 问题 3：竞标轮次在列表中看不到

**原因**：可能被其他筛选条件隐藏

**解决**：
1. 清除所有筛选器
2. 使用搜索框按名称搜索
3. 按创建时间倒序排列

---

## 🔐 权限说明

以下操作需要 **Staff 权限**：
- ✅ 创建/编辑竞标轮次
- ✅ 使用 Admin Actions（创建轮次、分配竞标）
- ✅ 查看所有竞标和结果
- ✅ 编辑谱面信息

普通用户（非 Staff）：
- ✅ 可通过 API 竞标
- ✅ 可查看自己的竞标结果
- ❌ 无法访问 Admin 界面

---

## 📚 相关链接

- [CHART_BIDDING_SUMMARY.md](./CHART_BIDDING_SUMMARY.md) - 功能总结
- [CHART_BIDDING_GUIDE.md](./CHART_BIDDING_GUIDE.md) - API 使用指南
- Django Admin 文档：https://docs.djangoproject.com/en/6.0/ref/contrib/admin/

---

## ✨ 新增 Admin 功能一览

| 功能 | 位置 | 说明 |
|------|------|------|
| 快速创建谱面竞标 | BiddingRound Action | 一键创建并自动筛选半成品谱面 |
| 分配竞标 | BiddingRound Action | 执行竞标分配算法 |
| 可用目标数显示 | BiddingRound 列表 | 显示该轮次的可竞标目标数 |
| 半成品筛选 | Chart 筛选器 | 按状态筛选可竞标的谱面 |
| 设计者搜索 | Chart 搜索 | 支持按设计者名义搜索谱面 |
| 设计者显示 | Chart 列表 | 新增设计者名义列 |

